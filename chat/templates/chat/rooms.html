{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{data.room_name}}</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="{% static 'chat/styles.css' %}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
</head>
<body>
    <div class="container-fluid h-100" style="padding: 0;">
        <div class="row no-gutters h-100">
            <!-- Sidebar -->
            <div class="col-2 sidebar text-light">
                <div id="sh100" class="d-flex flex-column h-100">
                    <div class="p-3">
                        <h4 class="text-center" style="font-size: medium;"><span>GROUPZ</span></h4>
                    </div>
                    <div class="nav flex-column nav-pills p-3">
                        <a class="nav-link text-light active" href="{% url 'index' %}"><i class="fas fa-comments"></i><span>All chats</span></a>
                        <a class="nav-link text-light" href="{% url 'tabs' 'work' %}"><i class="fas fa-briefcase"></i><span>Work</span></a>
                        <a class="nav-link text-light" href="{% url 'tabs' 'friends' %}"><i class="fas fa-user-friends"></i><span>Friends</span></a>
                        <a class="nav-link text-light" href="{% url 'tabs' 'news' %}"><i class="fas fa-newspaper"></i><span>News</span></a>
                        <a id="user_name" data-username="{{ user.username }}" class="nav-link text-light mt-auto" href="#"><i class="fas fa-user"></i><span>{{user.username}}</span></a>
                        <a class="nav-link text-light"><i class="fas fa-archive"></i><span>UID: {{user.id}}</span></a>
                        <a class="nav-link text-light" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i><span>Log out</span></a>
                    </div>
                </div>
            </div>

            <!-- Chat List -->
            <div class="col-3 bg-light border-right">
                <!-- <div class="p-3">
                    <input style="border-radius: 15px;" type="text" class="form-control" placeholder="Search">
                </div> -->
                <div id="chatlist" class="chat-list p-3">
                    
                    <div class="chat-item">
                        <div class="d-flex align-items-center" style="justify-content: center;">
                           
                                <button type="button" class="btn btn-primary" style="border-radius: 15px;" data-toggle="modal" data-target="#createRoomModal">
                                    <span>Create Room</span>
                                </button>
                            
                        </div>
                    </div>
                    
                    {% for room in rooms %}
                    
                    <a class="chat-item" style="cursor: pointer; text-decoration: none; color: black;" href="{% url 'rooms' room.id %}">
                        <div class="chat-item">
                            <div class="d-flex align-items-center">
                                <img src="https://res.cloudinary.com/dlb65j6di/image/upload/v1721462638/Untitled_design_12_srj8f1.png" class="rounded-circle mr-2" alt="User">
                                <div>
                                    <div class="font-weight-bold">{{room.room_name}}</div>
                                    <div id="{{room.id}}" class="text-muted">{{ room.latest_message|default:"No messages yet"|truncate_chars:20 }}</div>
                                </div>
                                
                            </div>
                        </div>
                    </a>
                    
                    {% endfor %}
                    

                    <!-- Add more chat items as needed -->
                </div>
            </div>

            <!-- Chat Window -->
            <div class="col-7 bg-white">
                <div class="d-flex flex-column h-100">
                    <div class="chat-header p-3 border-bottom">
                        <a href="{% url 'settings' data.id %}" style="text-decoration: none; color: #004705;">
                            <h5 id="category">{{data.room_name}} <small style="font-size: 0.7rem;">{{data.category}}</small></h5>
                        </a>
                        <small id="members">{{members_count}} member(s) </small>
                    </div>
                    <div id="chatbox" class="chat-body p-3 flex-grow-1 overflow-auto" style="height: 400px;">
                        {% for msg in msgs %}
                            {% if msg.sender == me %}
                                <div class="message-sent" >
                                    <div class="d-flex align-items-center mb-2" style="justify-content: end;">
                                        <div>
                                            <div  class="font-weight-bold" style="text-align:end; padding-right: 5px;">You</div>
                                            <div  class="text-muted small" style="text-align: end; padding-right: 5px;">{{msg.timestamp}}</div>
                                        </div>
                                        <img  src="https://res.cloudinary.com/dlb65j6di/image/upload/v1721462262/Untitled_design_11_tsonia.png" class="rounded-circle mr-2" alt="User">
                                    </div>
                                    <div  class="message-content-sent bg-light p-2 rounded" >
                                        {{msg.message}}
                                    </div>
                                </div>
                            {% else %}
                                <div class="message">
                                    <div class="d-flex align-items-center mb-2">
                                        <img  src="https://res.cloudinary.com/dlb65j6di/image/upload/v1721462263/Untitled_design_10_ftghsm.png" class="rounded-circle mr-2" alt="User">
                                        <div>
                                            <div  class="font-weight-bold">{{msg.sender}}</div>
                                            <div  class="text-muted small">{{msg.timestamp}}</div>
                                        </div>
                                    </div>
                                    <div  class="message-content bg-light p-2 rounded">
                                        {{msg.message}}
                                    </div>
                                </div>
                            {% endif %}    
                        {% endfor %}
                    </div>
                    <div  class="chat-footer p-3 border-top">
                        <div class="input-group">
                            <textarea style="border-top-left-radius: 15px; border-bottom-left-radius: 15px;" id="message" class="form-control" placeholder="Your message"></textarea>
                            <div class="input-group-append">
                                <button style="border-top-right-radius: 15px; border-bottom-right-radius: 15px;" id="msg-form" type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="createRoomModal" tabindex="-1" role="dialog" aria-labelledby="createRoomModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createRoomModalLabel">Create New Room</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="createRoomForm" method="post" action="{% url 'create_room' %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_room_name">Room Name</label>
                            <input style="border-radius: 15px;" type="text" class="form-control" id="id_room_name" name="room_name" required>
                        </div>
                        <div class="form-group">
                            <label for="id_category">Category</label>
                            <select style="border-radius: 15px;" class="form-control" id="id_category" name="category">
                                <option value="Work">Work</option>
                                <option selected value="Friends">Friends</option>
                                <option value="News">News</option>
                            </select>
                        </div>
                        <button style="border-radius: 15px;" type="submit" class="btn btn-primary">Create</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function(){
        $('#createRoomForm').on('submit', function(event){
            event.preventDefault();

            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success: function(response){
                    // Handle successful response
                    $('#createRoomModal').modal('hide');
                    // Optionally, refresh the page or update the room list dynamically
                    location.reload();
                },
                error: function(response){
                    // Handle error response
                    alert('Error creating room.');
                }
            });
        });
    });
    </script>

    <script>

        // Scroll to bottom
        const chats_div = document.getElementById("chatbox");
        const scrollToBottom = () => {
          chats_div.scrollTop = chats_div.scrollHeight;
        };
        
        function formatTimestamp(date) {
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    hour12: true 
                };
                return date.toLocaleString('en-US', options);
            }
        function truncateText(text, maxLength) {
            if (text.length > maxLength) {
                return text.substring(0, maxLength) + "...";
            } else {
                return text;
            }
        }

        // var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        // const socketURL = `${ws_scheme}://${window.location.host}/ws/messages/{{data.id}}/`;
        const socketURL = `ws://${window.location.host}/ws/messages/{{data.id}}/`;
        const socket = new WebSocket(socketURL)

        scrollToBottom();
    
        // Send Message to the backend
        const message_form = document.getElementById("msg-form")
        message_form.addEventListener("click", function (event) {
            event.preventDefault();
            console.log("Sending Message")
            let message_sent = document.getElementById("message").value;
            const timestamp = new Date();
            const formattedTimestamp = formatTimestamp(timestamp);

          if (message_sent.trim() != "") {
            socket.send(
                JSON.stringify({
                    message: message_sent,
                    room_name: "{{data.id}}",
                    sender: "{{me}}",
                    time: formattedTimestamp,
                    })
            );

          } else {
            console.log("Empty Message");
          }
          
        });
    
        // Recieve Message from the backend
        socket.addEventListener("message", (e) => {
          const data = JSON.parse(e.data)["message"]
    
          console.log(data);
    
          let sender = data["sender"];
          let content = data["message"];
          let time = data["time"];
    
          if (sender == "{{me}}") {
            document.getElementById("message").value = ""
          }
    
          const messageContainer = document.createElement('div');
          if (sender == "{{me}}") {
            chats_div.innerHTML += `<div class="message-sent" >
                                    <div class="d-flex align-items-center mb-2" style="justify-content: end;">
                                        <div>
                                            <div  class="font-weight-bold" style="text-align:end; padding-right: 5px;">You</div>
                                            <div  class="text-muted small" style="text-align: end; padding-right: 5px;">${time}</div>
                                        </div>
                                        <img  src="https://res.cloudinary.com/dlb65j6di/image/upload/v1721462262/Untitled_design_11_tsonia.png" class="rounded-circle mr-2" alt="User">
                                    </div>
                                    <div  class="message-content-sent bg-light p-2 rounded" >
                                        ${content}
                                    </div>
                                </div>`;
          } else if (sender == "Gemini AI") {
            
            chats_div.innerHTML += `<div class="message">
                                    <div class="d-flex align-items-center mb-2">
                                        <img  src="https://res.cloudinary.com/dlb65j6di/image/upload/v1721470498/Untitled_design_13_kwi427.png" class="rounded-circle mr-2" alt="User">
                                        <div>
                                            <div  class="font-weight-bold">${sender}</div>
                                            <div  class="text-muted small">${time}</div>
                                        </div>
                                    </div>
                                    <div  class="message-content-ai bg-light p-2 rounded">
                                        ${content}
                                    </div>
                                </div>`;

          } else if (sender == "Llama3 AI") {

            chats_div.innerHTML += `<div class="message">
                                    <div class="d-flex align-items-center mb-2">
                                        <img  src="https://res.cloudinary.com/dlb65j6di/image/upload/v1721473225/Untitled_design_14_valigh.png" class="rounded-circle mr-2" alt="User">
                                        <div>
                                            <div  class="font-weight-bold">${sender}</div>
                                            <div  class="text-muted small">${time}</div>
                                        </div>
                                    </div>
                                    <div  class="message-content-ai bg-light p-2 rounded">
                                        ${content}
                                    </div>
                                </div>`;

          } else {
            chats_div.innerHTML += `<div class="message">
                                    <div class="d-flex align-items-center mb-2">
                                        <img  src="https://res.cloudinary.com/dlb65j6di/image/upload/v1721462263/Untitled_design_10_ftghsm.png" class="rounded-circle mr-2" alt="User">
                                        <div>
                                            <div  class="font-weight-bold">${sender}</div>
                                            <div  class="text-muted small">${time}</div>
                                        </div>
                                    </div>
                                    <div  class="message-content bg-light p-2 rounded">
                                        ${content}
                                    </div>
                                </div>`;
          }
    
          scrollToBottom();

          document.getElementById("{{data.id}}").innerHTML = truncateText(content, 20);
    
        });
      </script>

</body>
</html>

